# Receipt API (Google Apps Script) — Updated

**Last updated:** 2025-09-06 03:26:32 +07

This is a **Google Apps Script Web API** that manages receipts using Google Sheets (2 sheets: **Info** and **Item**).  
This version adds support for **`WithholdingTax`** in the `Item` sheet.

---

## Base URL & Auth

**Base URL**  
```
https://script.google.com/macros/s/AKfycbzg_q9wJGeF0b-nlqZsQoQ2GbALv-c_0cVkoPvCAc08Mvjn7W_ymskSBkefGQU95ZxdBg/exec
```

**Authentication**  
Pass a token either in querystring or JSON body:
```
?token=1458600036423
```
> The script validates against `Script Properties` (`API_TOKEN`). There is a fallback hardcoded token for testing.

---

## Sheet Structure

### Sheet: Info
Columns (row 1 header must match exactly):
- `ID`
- `NameSeller`
- `SellerAddress`
- `SellerTaxId`
- `BuyerName`
- `BuyerAddress`
- `BuyerTaxId`
- `BuyerOrgType`
- `RefCodeInfoItem`
- `CreateDate`
- `UpdateDate`
- `RecordId`

### Sheet: Item (Updated)
Columns (row 1 header must match exactly):
- `ID`
- `RefCodeInfoItem`
- `Item`
- `Amount`
- `Price`
- `WithholdingTax` ← **new** (number, THB; default `0` if omitted)

---

## Data Model (JSON)

### Info (object)
```json
{
  "ID": 1,
  "NameSeller": "string",
  "SellerAddress": "string",
  "SellerTaxId": "string",
  "BuyerName": "string",
  "BuyerAddress": "string",
  "BuyerTaxId": "string",
  "BuyerOrgType": "string",
  "RefCodeInfoItem": "INV-2025-0001",
  "CreateDate": "ISO-8601",
  "UpdateDate": "ISO-8601",
  "RecordId": "string"
}
```

### Item (object) — updated
```json
{
  "ID": 1,
  "RefCodeInfoItem": "INV-2025-0001",
  "Item": "string",
  "Amount": 1,
  "Price": 100,
  "WithholdingTax": 30
}
```

> `WithholdingTax` is treated as an **absolute amount** (baht). If not provided, it is stored as `0`.

---

## Endpoints

### 1) Ping
**GET** `?action=ping&token=1458600036423`

Response
```json
{ "ok": true, "data": { "pong": true, "time": "..." } }
```

---

### 2) Create Receipt
**POST** `?token=1458600036423`

Body
```json
{
  "action": "create",
  "info": {
    "NameSeller": "ร้านเอ บจก.",
    "SellerAddress": "123 ถนนสุขุมวิท กรุงเทพฯ",
    "SellerTaxId": "0105559999999",
    "BuyerName": "คุณบี",
    "BuyerAddress": "99 ถ.พหลโยธิน กรุงเทพฯ",
    "BuyerTaxId": "0105566666666",
    "BuyerOrgType": "บุคคลธรรมดา",
    "RefCodeInfoItem": "INV-2025-0010",
    "RecordId": "rec_abc123"
  },
  "items": [
    { "Item": "บริการ X", "Amount": 1, "Price": 1000, "WithholdingTax": 30 },
    { "Item": "สินค้า A", "Amount": 2, "Price": 200 }
  ]
}
```

Response
```json
{
  "ok": true,
  "data": {
    "info": { "...": "..." },
    "items": [ { "...": "..." } ]
  }
}
```

---

### 3) Get Receipt (by `ID` or `RefCodeInfoItem`)
**GET** `?action=get&ref=INV-2025-0010&token=1458600036423`

Response
```json
{
  "ok": true,
  "data": {
    "info": { "...": "..." },
    "items": [ { "WithholdingTax": 30, "...": "..." } ]
  }
}
```

---

### 4) Update Receipt
**POST** `?token=1458600036423`

Body
```json
{
  "action": "update",
  "criteria": { "RefCodeInfoItem": "INV-2025-0010" },
  "patch": { "BuyerName": "คุณบี (แก้ไข)", "BuyerOrgType": "นิติบุคคล" },
  "itemsMode": "replace",
  "items": [
    { "Item": "สินค้า B", "Amount": 3, "Price": 150, "WithholdingTax": 15 }
  ]
}
```

`itemsMode` values:
- `replace` — delete old items and insert provided list
- `append` — keep old items and add provided list
- `noop` — update only Info (ignore items section)

---

### 5) Add Items to Existing Receipt
**POST** `?token=1458600036423`

Body
```json
{
  "action": "add_items",
  "ref": "INV-2025-0010",
  "items": [
    { "Item": "บริการเสริม Y", "Amount": 1, "Price": 500, "WithholdingTax": 50 }
  ]
}
```

---

### 6) Get Items Only (by `RefCodeInfoItem`)
**GET** `?action=items&ref=INV-2025-0010&token=1458600036423`

Response
```json
{
  "ok": true,
  "data": [
    { "ID": 2, "RefCodeInfoItem": "INV-2025-0010", "Item": "บริการ X", "Amount": 1, "Price": 1000, "WithholdingTax": 30 }
  ]
}
```

---

## Implementation Notes

- **Headers mapping is dynamic**: the script writes/reads by column headers, so ensure row 1 names match exactly (case-sensitive).
- **ID auto-increment**: managed per-sheet via `PropertiesService` (`NEXT_ID_INFO`, `NEXT_ID_ITEM`).
- **Dates**: `CreateDate` set only when created; `UpdateDate` refreshed on every update.
- **Join key**: `RefCodeInfoItem` links `Info` ↔ `Item`.
- **CORS**: Using `ContentService` JSON responses; no custom headers set. Works for web apps.
- **Deploy**: Deploy as **Web App** (`Execute as: Me`, `Who has access: Anyone/Anyone with link`), update deployment after code changes.

---

## Roadmap (Optional Enhancements)

- **DELETE endpoint**: remove an entire receipt (Info + Items) by `ID`/`RefCodeInfoItem`.
- **Totals**: return computed totals (`subtotal`, `withholdingSum`, `grandTotal`) in responses.
- **WHT by rate**: support `WithholdingTaxRate` (%) and calculate amount server-side.
- **Export**: generate printable receipt (PDF/PNG) for thermal printers.
- **Auth**: replace token with OAuth/JWT or Google Identity for stricter access control.

---

## Quick cURL Snippets

```bash
# Ping
curl "https://script.google.com/macros/s/AKfycbzg_q9wJGeF0b-nlqZsQoQ2GbALv-c_0cVkoPvCAc08Mvjn7W_ymskSBkefGQU95ZxdBg/exec?action=ping&token=1458600036423"

# Create
curl -X POST "https://script.google.com/macros/s/AKfycbzg_q9wJGeF0b-nlqZsQoQ2GbALv-c_0cVkoPvCAc08Mvjn7W_ymskSBkefGQU95ZxdBg/exec?token=1458600036423" -H "Content-Type: application/json" -d '{
  "action":"create",
  "info":{"RefCodeInfoItem":"INV-2025-0011","NameSeller":"ร้านเอ บจก."},
  "items":[{"Item":"บริการ X","Amount":1,"Price":1000,"WithholdingTax":30}]
}'

# Get
curl "https://script.google.com/macros/s/AKfycbzg_q9wJGeF0b-nlqZsQoQ2GbALv-c_0cVkoPvCAc08Mvjn7W_ymskSBkefGQU95ZxdBg/exec?action=get&ref=INV-2025-0011&token=1458600036423"

# Update (append)
curl -X POST "https://script.google.com/macros/s/AKfycbzg_q9wJGeF0b-nlqZsQoQ2GbALv-c_0cVkoPvCAc08Mvjn7W_ymskSBkefGQU95ZxdBg/exec?token=1458600036423" -H "Content-Type: application/json" -d '{
  "action":"update",
  "criteria":{"RefCodeInfoItem":"INV-2025-0011"},
  "patch":{"BuyerName":"คุณบี"},
  "itemsMode":"append",
  "items":[{"Item":"ส่วนเพิ่ม","Amount":1,"Price":0,"WithholdingTax":10}]
}'
```